<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Audio Reactive Spheres</title>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
    <script src="https://threejs.org/build/three.js"></script>
    <script src="https://unpkg.com/delaunator@3.0.2/delaunator.js"></script>
    <script src="https://josephg.github.io/noisejs/perlin.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.3/dat.gui.min.js"></script>
</head>
<body>
    <button id="startButton">Start</button>
    <div id="thresholds"></div>
    <div id="container"></div>
    <script>
        let hueoffset = 120;
        let volumeThreshold = 50;
        let thresholds = Array(22).fill(40);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 2;
        const renderer = new THREE.WebGLRenderer();

        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        var analyser;

        let numBands = 22;
        
        let points = [];
        let lines = [];
        let geometries = [];
        let lastPoints = [];

        let goldenRatio = (1 + Math.sqrt(5)) / 2;
        let angleIncrement = Math.PI * 2 * goldenRatio;

        for (let i = 0; i < numBands; i++) {
            let v = i / numBands;
            let phi = v * Math.PI;
            let theta = angleIncrement * i;

            let x = Math.sin(phi) * Math.cos(theta);
            let y = Math.sin(phi) * Math.sin(theta);
            let z = Math.cos(phi);

            x = isNaN(x) ? 0 : x;
            y = isNaN(y) ? 0 : y;
            z = isNaN(z) ? 0 : z;

            let point = new THREE.Points(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0)]), new THREE.PointsMaterial({color: 0xffffff, size: 0.01}));
            point.position.set(x, y, z);
            points.push(point);
            // scene.add(point);
        }

        function createTriangleGeometry(a, b, c) {
            var geometry = new THREE.BufferGeometry();

            var vertices = new Float32Array([
                a.x, a.y, a.z,
                b.x, b.y, b.z,
                c.x, c.y, c.z
            ]);

            var indices = new Uint16Array([0, 1, 2]);

            geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            geometry.setIndex(new THREE.BufferAttribute(indices, 1));

            return geometry;
        }

        function getAverageVolume(array) {
            var values = 0;
            var average;
            var length = array.length;
            for (var i = 0; i < length; i++) {
                values += array[i];
            }
            average = values / length;
            return average;
        }

        let hueOffsetSpeed = 0.5;

        function animate() {
            requestAnimationFrame(animate);

            hueoffset += hueOffsetSpeed;
            if(hueoffset > 360) {
                hueoffset -= 360;
            }

            let data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);

            let bandSize = Math.floor(data.length / numBands);
            
            for (let i = 0; i < numBands; i++) {
                let band = data.slice(i * bandSize, (i + 1) * bandSize);
                let volume = getAverageVolume(band);
                
                if (volume >= thresholds[i]) {
                    let hue = volume + hueoffset;
                    if (hue > 360) hue -= 360;
                    let color = new THREE.Color('hsl(' + hue + ', 100%, 50%)');

                    if(points[i]) points[i].material.color = color;

                    if (lastPoints.length >= 3) {
                        var geometry = createTriangleGeometry(lastPoints[0], lastPoints[1], lastPoints[2]);
                        var material = new THREE.MeshBasicMaterial({color: color, opacity: 0.6, transparent: true, side: THREE.DoubleSide});
                        var triangle = new THREE.Mesh(geometry, material);
                        scene.add(triangle);
                        geometries.push({geometry: triangle, age: 0});

                        lastPoints.shift();
                    }

                    lastPoints.push(points[i].position.clone());
                }
            }

            for (let i = geometries.length - 1; i >= 0; i--) {
                geometries[i].age++;
                if (geometries[i].age > 20) {
                    geometries[i].geometry.material.opacity -= 0.01;
                    if (geometries[i].geometry.material.opacity <= 0) {
                        scene.remove(geometries[i].geometry);
                        geometries.splice(i, 1);
                    }
                }
            }

            renderer.render(scene, camera);
        }

        let startButton = document.getElementById('startButton');
        startButton.addEventListener('click', function() {
            startButton.parentElement.removeChild(startButton);

            navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(function(stream) {
                let audioContext = new AudioContext();
                let source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);
                animate();
            });
        });

        let thresholdContainer = document.getElementById('thresholds');
        for (let i = 0; i < numBands; i++) {
            let threshold = document.createElement('div');
            let thresholdInput = document.createElement('input');
            thresholdInput.type = 'range';
            thresholdInput.min = '0';
            thresholdInput.max = '255';
            thresholdInput.value = thresholds[i];
            thresholdInput.addEventListener('change', function() {
                thresholds[i] = parseInt(this.value);
            });
            threshold.appendChild(thresholdInput);
            let thresholdLabel = document.createElement('label');
            thresholdLabel.innerText = 'Threshold for Band ' + (i + 1) + ': ' + thresholds[i];
            threshold.appendChild(thresholdLabel);
            thresholdContainer.appendChild(threshold);
        }
    </script>
</body>
</html>
